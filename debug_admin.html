<!DOCTYPE html>
<html>

<head>
  <title>管理员调试工具</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    .section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    button {
      padding: 10px 15px;
      margin: 5px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }

    button:hover {
      background: #0056b3;
    }

    .result {
      margin: 10px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 3px;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
    }

    .success {
      background: #d4edda;
      color: #155724;
    }
  </style>
</head>

<body>
  <h1>管理员功能调试工具</h1>

  <div class="section">
    <h3>1. 检查本地存储的Token</h3>
    <button onclick="checkToken()">检查Token</button>
    <div id="tokenResult" class="result"></div>
  </div>

  <div class="section">
    <h3>2. 测试用户信息API</h3>
    <button onclick="testUserInfo()">测试 /auth/me</button>
    <div id="userResult" class="result"></div>
  </div>

  <div class="section">
    <h3>3. 测试管理员API</h3>
    <button onclick="testAdminAPI()">测试 /api/admin/users</button>
    <div id="adminResult" class="result"></div>
  </div>

  <div class="section">
    <h3>4. 管理员登录</h3>
    <input type="email" id="adminEmail" placeholder="管理员邮箱" value="490429443@qq.com"
      style="width: 200px; padding: 8px;">
    <input type="password" id="adminPassword" placeholder="密码" style="width: 200px; padding: 8px;">
    <button onclick="loginAdmin()">登录</button>
    <div id="loginResult" class="result"></div>
  </div>

  <script>
    const API_BASE = 'http://localhost:8001';

    function checkToken() {
      const token = localStorage.getItem('auth_token');
      const result = document.getElementById('tokenResult');

      if (token) {
        result.innerHTML = `<div class="success">Token存在: ${token.substring(0, 20)}...</div>`;

        // 尝试解析Token（简单解码，不验证签名）
        try {
          const payload = JSON.parse(atob(token.split('.')[1]));
          result.innerHTML += `<div>Token内容: <pre>${JSON.stringify(payload, null, 2)}</pre></div>`;
        } catch (e) {
          result.innerHTML += `<div class="error">Token解析失败: ${e.message}</div>`;
        }
      } else {
        result.innerHTML = '<div class="error">未找到Token，请先登录</div>';
      }
    }

    async function testUserInfo() {
      const result = document.getElementById('userResult');
      const token = localStorage.getItem('auth_token');

      if (!token) {
        result.innerHTML = '<div class="error">未找到Token，请先登录</div>';
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/auth/me`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();

        if (response.ok) {
          result.innerHTML = `<div class="success">用户信息获取成功</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>`;
        } else {
          result.innerHTML = `<div class="error">获取用户信息失败 (${response.status}): ${data.detail || response.statusText}</div>`;
        }
      } catch (error) {
        result.innerHTML = `<div class="error">网络错误: ${error.message}</div>`;
      }
    }

    async function testAdminAPI() {
      const result = document.getElementById('adminResult');
      const token = localStorage.getItem('auth_token');

      if (!token) {
        result.innerHTML = '<div class="error">未找到Token，请先登录</div>';
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/admin/users`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();

        if (response.ok) {
          result.innerHTML = `<div class="success">管理员API调用成功</div>
                        <div>用户数量: ${data.users?.length || 0}</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>`;
        } else {
          result.innerHTML = `<div class="error">管理员API调用失败 (${response.status}): ${data.detail || response.statusText}</div>`;
        }
      } catch (error) {
        result.innerHTML = `<div class="error">网络错误: ${error.message}</div>`;
      }
    }

    async function loginAdmin() {
      const result = document.getElementById('loginResult');
      const email = document.getElementById('adminEmail').value;
      const password = document.getElementById('adminPassword').value;

      if (!email || !password) {
        result.innerHTML = '<div class="error">请输入邮箱和密码</div>';
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/auth/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            identifier: email,
            password: password,
            login_type: 'email'
          })
        });

        const data = await response.json();

        if (response.ok) {
          localStorage.setItem('auth_token', data.access_token);
          result.innerHTML = `<div class="success">登录成功！</div>
                        <div>用户: ${data.user.username} (${data.user.email})</div>
                        <div>Token已保存到localStorage</div>`;
        } else {
          result.innerHTML = `<div class="error">登录失败 (${response.status}): ${data.detail || response.statusText}</div>`;
        }
      } catch (error) {
        result.innerHTML = `<div class="error">网络错误: ${error.message}</div>`;
      }
    }

    // 页面加载时自动检查Token
    window.onload = function () {
      checkToken();
    };
  </script>
</body>

</html>